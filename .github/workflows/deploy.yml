name: Deploy FOTO-PATAGONIA (PROD)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      rollback_commit:
        description: "Commit hash opcional para rollback (vacío = último main)"
        required: false
        default: ""

concurrency:
  group: foto-patagonia-prod
  cancel-in-progress: true

env:
  REPO_URL: https://github.com/${{ github.repository }}.git
  DEPLOY_DIR: /opt/apps/foto-patagonia
  COMPOSE_FILE: docker-compose.prod.yml
  BRANCH: main

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Preparar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Deploy PROD en Droplet
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes \
          ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }} "bash -s" <<'REMOTE'
            set -euo pipefail

            echo "=== DEPLOY FOTO-PATAGONIA PROD ==="

            # Variables DEFINIDAS en el servidor
            REPO="https://github.com/omegonstudio/fotos-patagonia.git"
            DIR="/opt/apps/foto-patagonia"
            BRANCH="main"
            COMPOSE="docker-compose.prod.yml"

            mkdir -p "$DIR"
            cd "$DIR"

            if [ ! -d ".git" ]; then
              echo "-> Clonando repositorio"
              git clone "$REPO" .
            fi

            echo "-> Guardando commit previo"
            git rev-parse --short HEAD > .last_deploy_commit || true

            git fetch origin

            echo "-> Actualizando a origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            echo "->  Apply database migrations"
          
            docker compose -f "$COMPOSE" run --rm backend alembic upgrade head

            echo "-> Build y run con Docker Compose"
            docker compose -f "$COMPOSE" up -d --build

            echo "-> Estado de contenedores"
            docker compose -f "$COMPOSE" ps

            echo "=== DEPLOY PROD COMPLETADO ==="
          REMOTE

