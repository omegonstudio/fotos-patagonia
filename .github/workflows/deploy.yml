name: Deploy FOTO-PATAGONIA (PROD)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      rollback_commit:
        description: "Commit hash opcional para rollback"
        required: false
        default: ""

concurrency:
  group: foto-patagonia-prod
  cancel-in-progress: true

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Preparar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Deploy en Droplet
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes \
          ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }} "bash -s" <<'REMOTE'
            set -euo pipefail

            echo "=== DEPLOY FOTO-PATAGONIA PROD ==="

            REPO="https://github.com/omegonstudio/fotos-patagonia.git"
            DIR="/opt/apps/foto-patagonia"
            BRANCH="main"
            COMPOSE="docker-compose.prod.yml"

            mkdir -p "$DIR"
            cd "$DIR"

            if [ ! -d ".git" ]; then
              echo "-> Clonando repositorio"
              git clone "$REPO" .
            fi

            echo "-> Guardando commit previo"
            git rev-parse --short HEAD > .last_deploy_commit || true

            echo "-> Fetch + reset"
            git fetch origin
            git reset --hard "origin/$BRANCH"

            echo "-> Bajando stack previo"
            docker compose -f "$COMPOSE" down --remove-orphans || true

            echo "-> Build sin cache"
            docker compose -f "$COMPOSE" build --no-cache

            echo "-> Levantando stack"
            docker compose -f "$COMPOSE" up -d --remove-orphans

            echo "-> Estado de contenedores"
            docker compose -f "$COMPOSE" ps

            echo "-> Logs backend (últimas 120 líneas)"
            docker logs fotopatagonia-backend --tail=120 || true

            echo "-> Logs frontend (últimas 120 líneas)"
            docker logs fotopatagonia-frontend --tail=120 || true

            echo "=== DEPLOY COMPLETADO ==="
          REMOTE
