name: Deploy FOTO-PATAGONIA (PROD)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      rollback_commit:
        description: "Commit hash opcional para rollback (vacío = último main)"
        required: false
        default: ""

concurrency:
  group: foto-patagonia-prod
  cancel-in-progress: true

env:
  REPO_URL: https://github.com/${{ github.repository }}.git
  DEPLOY_DIR: /opt/apps/foto-patagonia
  COMPOSE_FILE: docker-compose.prod.yml
  BRANCH: main

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Preparar SSH
        run: |
         mkdir -p ~/.ssh
         echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
         chmod 600 ~/.ssh/id_rsa
         ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts
         chmod 644 ~/.ssh/known_hosts

      - name: Deploy PROD en Droplet
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes \
          ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }} "bash -s" <<'REMOTE'
            set -euo pipefail

            echo "=== DEPLOY FOTO-PATAGONIA PROD ==="

            REPO="${REPO_URL}"
            DIR="${DEPLOY_DIR}"
            BRANCH="${BRANCH}"
            COMPOSE="${COMPOSE_FILE}"
            ROLLBACK="${{ github.event.inputs.rollback_commit || '' }}"

            mkdir -p "$DIR"
            cd "$DIR"

            if [ ! -d ".git" ]; then
              echo "-> Clonando repositorio"
              git clone "$REPO" .
            fi

            echo "-> Guardando commit previo"
            git rev-parse --short HEAD > .last_deploy_commit || true

            git fetch origin

            if [ -n "$ROLLBACK" ]; then
              echo "-> Rollback al commit $ROLLBACK"
              git checkout --force "$ROLLBACK"
            else
              echo "-> Actualizando a origin/$BRANCH"
              git reset --hard "origin/$BRANCH"
            fi

            echo "-> Build y run con Docker Compose"
            docker compose -f "$COMPOSE" up -d --build

            echo "-> Estado de contenedores"
            docker compose -f "$COMPOSE" ps

            echo "=== DEPLOY PROD COMPLETADO ==="
          REMOTE
